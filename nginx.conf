events {
    worker_connections 1024;
}

http {
    upstream mobile_backend {
        server mobileaggregator:80;
    }
    
    upstream web_backend {
        server webgateway:80;
    }
    
    upstream integration_backend {
        server integrationgateway:80;
    }

    # Mobile API Gateway
    server {
        listen 80;
        server_name mobile.zapfinance.local localhost;
        
        location /api/mobile/ {
            rewrite ^/api/mobile/(.*) /$1 break;
            proxy_pass http://mobile_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /mobile/ {
            rewrite ^/mobile/(.*) /$1 break;
            proxy_pass http://mobile_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Web API Gateway
    server {
        listen 80;
        server_name web.zapfinance.local;
        
        location /api/web/ {
            rewrite ^/api/web/(.*) /$1 break;
            proxy_pass http://web_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /web/ {
            rewrite ^/web/(.*) /$1 break;
            proxy_pass http://web_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Integration API Gateway
    server {
        listen 80;
        server_name integration.zapfinance.local;
        
        location /api/integration/ {
            rewrite ^/api/integration/(.*) /$1 break;
            proxy_pass http://integration_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /integration/ {
            rewrite ^/integration/(.*) /$1 break;
            proxy_pass http://integration_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-for $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Main Gateway - Routes to all services
    server {
        listen 80 default_server;
        server_name _;
        
        # Health check endpoint
        location /health {
            return 200 "ZapFinance API Gateway is running!";
            add_header Content-Type text/plain;
        }
        
        # Mobile routes
        location /api/auth {
            proxy_pass http://mobile_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /api/user {
            proxy_pass http://mobile_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Swagger documentation
        location /swagger {
            proxy_pass http://mobile_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Default route
        location / {
            return 200 '
            <!DOCTYPE html>
            <html>
            <head>
                <title>ZapFinance API Gateway</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
                    .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                    h1 { color: #2c3e50; }
                    .service { margin: 20px 0; padding: 15px; background: #ecf0f1; border-radius: 5px; }
                    a { color: #3498db; text-decoration: none; }
                    a:hover { text-decoration: underline; }
                </style>
            </head>
            <body>
                <div class="container">
                    <h1>üè¶ ZapFinance API Gateway</h1>
                    <p>Bem-vindo ao sistema ZapFinance com arquitetura hexagonal!</p>
                    
                    <div class="service">
                        <h3>üì± Mobile API</h3>
                        <p><a href="/swagger">Swagger Documentation</a></p>
                        <p><a href="/api/auth">Authentication Endpoints</a></p>
                        <p><a href="/api/user">User Management</a></p>
                    </div>
                    
                    <div class="service">
                        <h3>üåê Web API</h3>
                        <p>Port: 5003</p>
                        <p><a href="http://localhost:5003">Direct Access</a></p>
                    </div>
                    
                    <div class="service">
                        <h3>üîó Integration API</h3>
                        <p>Port: 5004</p>
                        <p><a href="http://localhost:5004">Direct Access</a></p>
                    </div>
                    
                    <div class="service">
                        <h3>‚öôÔ∏è Core Service</h3>
                        <p>gRPC + REST: Port 5001</p>
                        <p><a href="http://localhost:5001">Direct Access</a></p>
                    </div>
                </div>
            </body>
            </html>';
            add_header Content-Type text/html;
        }
    }
}
